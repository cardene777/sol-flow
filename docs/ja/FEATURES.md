# Sol-Flow 機能詳細

Sol-Flowの機能と使い方の詳細ドキュメント。

## 目次

- [コントラクト可視化](#コントラクト可視化)
- [関数フロー図](#関数フロー図)
- [プロキシパターン検出](#プロキシパターン検出)
- [スマート検索](#スマート検索)
- [編集モード](#編集モード)
- [ソースコードビューア](#ソースコードビューア)
- [プロジェクト管理](#プロジェクト管理)
- [エクスポート機能](#エクスポート機能)

---

## コントラクト可視化

### 概要

Sol-FlowはReact Flowを使用してSolidityスマートコントラクトをインタラクティブなグラフとして可視化します。各コントラクトはノードとして表現され、コントラクト間の関係はエッジとして表示されます。

### ノードタイプ

| タイプ | 説明 |
|--------|------|
| `contractNode` | 展開可能な詳細を持つ個別コントラクト |
| `categoryGroupNode` | カテゴリ別グループ（Access、Token等） |
| `proxyPatternGroupNode` | プロキシ関連コントラクトのグループ（ERC-7546、UUPS等） |

### コントラクトノードの機能

- **折りたたみ表示**: コントラクト名と種類（contract/interface/library）を表示
- **展開表示**: 関数、イベント、状態変数を表示
- **色分け**: コントラクト種類ごとに異なる色
- **クリックで展開**: ノードをクリックして詳細を表示/非表示

### エッジタイプ

| タイプ | 色 | スタイル | 説明 |
|--------|-----|----------|------|
| `inherits` | 青 | 実線 | 継承関係（`is`） |
| `implements` | 紫 | 実線 | インターフェース実装 |
| `uses` | 黄 | 破線 | ライブラリ使用（`using X for Y`） |
| `delegatecall` | ピンク | 破線 | delegatecall関係 |
| `registers` | 紫 | 破線 | ディクショナリ登録（ERC-7546） |
| `imports` | グレー | 破線 | インポート依存 |

### レイアウトアルゴリズム

Sol-Flowは階層的レイアウトにdagreアルゴリズムを使用:
- 親コントラクトは子コントラクトの上に配置
- 同じカテゴリのコントラクトはグループ化
- プロキシパターンは専用セクションにグループ化

---

## 関数フロー図

### 概要

展開したコントラクトノード内の任意の関数をクリックすると、その呼び出しフロー図を表示します。

### 関数カテゴリ

| アイコン | 可視性 | 状態変更性 |
|---------|--------|----------|
| 緑 | external/public | view/pure |
| オレンジ | external/public | nonpayable/payable |
| 紫 | internal/private | すべて |

### 呼び出しフロー情報

関数フロー図には以下が表示されます:
- **内部呼び出し**: 同じコントラクト内で呼び出される関数
- **ライブラリ呼び出し**: ライブラリ関数の呼び出し
- **外部呼び出し**: 他のコントラクトへの呼び出し
- **super呼び出し**: 親コントラクト関数への呼び出し
- **delegatecall**: 低レベルdelegatecall操作
- **発行イベント**: 関数によってトリガーされるイベント
- **モディファイア**: アクセス制御等のモディファイア

### ソースコード表示

各関数のソースコードが以下の機能と共に表示されます:
- Solidityシンタックスハイライト
- 行番号
- クリップボードにコピーボタン

---

## プロキシパターン検出

Sol-Flowは以下のプロキシパターンを自動検出します:

### ERC-7546（Meta Contract / Borderless）

検出基準:
- ディレクトリ構造: `/functions/`、`/dictionary/`
- コントラクト名: `Dictionary`、`DictionaryCore`、`BorderlessProxy`
- イベント: `DictionaryUpgraded`
- 関数: `getDictionary`、`bulkSetImplementation`

ロール:
- **dictionary**: 中央レジストリコントラクト
- **proxy**: ユーザー向けプロキシコントラクト
- **implementation**: `/functions/`内の関数コントラクト

### UUPS（EIP-1822）

検出基準:
- 関数: `upgradeTo`、`upgradeToAndCall`、`proxiableUUID`、`_authorizeUpgrade`
- 継承: `UUPSUpgradeable`

### Transparent Proxy

検出基準:
- 継承: `TransparentUpgradeableProxy`
- 関数: `admin`

### Diamond（EIP-2535）

検出基準:
- 関数: `diamondCut`、`facets`、`facetAddress`
- イベント: `DiamondCut`
- ディレクトリ: `/facets/`

### Beacon Proxy

検出基準:
- 継承: `UpgradeableBeacon`、`BeaconProxy`
- `beacon`を含むコントラクト名

---

## スマート検索

### 機能

- コントラクト名で検索
- 関数名で検索
- イベント名で検索
- リアルタイムフィルタリング
- 選択したコントラクトへ自動ズーム

### 使い方

1. ヘッダーの検索アイコンをクリック
2. 検索クエリを入力
3. 結果をクリックしてそのコントラクトに移動

---

## 編集モード

### 概要

編集モードでは、静的解析で捉えられないカスタム関係エッジをコントラクト間に追加できます。

### ユースケース

- 自動検出されないプロキシ関係をドキュメント化
- クロスコントラクトの相互作用をドキュメントに追加
- 実行時の関係を可視化

### エッジの種類

1. **一時エッジ**: ページリロードで消える
   - 赤い破線
   - ホバーで削除ボタン（Xアイコン）を表示

2. **ユーザーエッジ**: プロジェクトと共に保存
   - シアン色
   - セッション間で永続化

### 使い方

1. ヘッダーのトグルで編集モードを有効化
2. ソースコントラクトをクリック
3. ターゲットコントラクトをクリック
4. 関係タイプを選択
5. エッジがダイアグラムに追加される

---

## ソースコードビューア

### 概要

Solidityシンタックスハイライト付きでコントラクトの完全なソースコードを表示します。

### 機能

- **フルソース表示**: import、コメント、pragmaを含む完全なファイルを表示
- **シンタックスハイライト**: Solidityキーワード、型、構文の適切な色分け
- **複数行コメント対応**: `/* */`と`/** */`コメントを正しく処理
- **NatSpecサポート**: `///`ドキュメントコメントをハイライト
- **行番号**: 簡単なコード参照
- **コピーボタン**: ワンクリックでクリップボードにコピー

### ソースコードへのアクセス

1. コントラクトノードをクリックして展開
2. 「詳細を表示」ボタンをクリック
3. 「Source」タブに切り替え

または:
- サイドバーでコントラクトにホバー
- コードアイコンをクリックして詳細モーダルを直接開く

---

## プロジェクト管理

### 機能

- **プロジェクト保存**: パース済みコントラクトデータをローカルに保存
- **プロジェクト読み込み**: 保存したプロジェクトで作業を再開
- **プロジェクト名変更**: プロジェクト名を更新
- **プロジェクト削除**: 不要なプロジェクトを削除
- **ライブラリ切り替え**: 内蔵ライブラリ間を切り替え

### ストレージ

プロジェクトはブラウザのlocalStorageに保存:
- `sol-flow-projects`: 保存済みプロジェクト一覧
- `sol-flow-project-{id}`: 個別プロジェクトのCallGraphデータ
- `sol-flow-current-project`: 現在アクティブなプロジェクトID
- `sol-flow-current-library`: 現在アクティブなライブラリID

---

## エクスポート機能

### 利用可能な形式

- **PNG**: 高解像度画像エクスポート
- **SVG**: スケーラブルベクターグラフィックス

### エクスポート方法

1. ヘッダーのエクスポートボタンをクリック
2. 形式を選択（PNGまたはSVG）
3. ダイアグラムがデバイスにダウンロードされる

### エクスポートに関する注意

- 現在のビューポートをエクスポート
- ズームレベルがPNG解像度に影響
- SVGエクスポートは解像度非依存
